name: rdn_workflow

conda_env: conda.yaml

entry_points:

  load_raw_data:
    parameters:
      series_csv: {type: str, default: ../../RDN/Load_Data/2009-2021-global-load.csv}
      series_uri: {type: str, default: online_artifact}
    command: |
      python load_raw_data.py --series-csv {series_csv} --series-uri {series_uri}

  etl:
    parameters:
      series_csv: {type: str, default: ../../RDN/Load_Data/2009-2021-global-load.csv}
      series_uri: {type: str, default: mlflow_artifact_uri}
      resolution: {type: str, default: 15}
      year_range: {type: str, default: 2009-2019}
      time_covs: {type: str, default: PT}
      day_first: {type: str, default: "true"}
    command: |
      python etl.py --series-csv {series_csv} --series-uri {series_uri} --resolution {resolution} --year-range {year_range} --time-covs {time_covs} --day-first {day_first}

  train:
    parameters:
      series_csv: {type: str, default: ../../RDN/Load_Data/series.csv}
      series_uri: {type: str, default: mlflow_artifact_uri}
      future_covs_csv: {type: str, default: None}
      future_covs_uri: {type: str, default: mlflow_artifact_uri}
      past_covs_csv: {type: str, default: None}
      past_covs_uri: {type: str, default: mlflow_artifact_uri}
      cut_date_val: {type: str, default: 20200101}
      cut_date_test: {type: str, default: 20210101}
      test_end_date: {type: str, default: None}
      darts_model: {type: str, default: RNN}
      device: {type: str, default: gpu}
      hyperparams_entrypoint: {type: str, default: LSTM1}
      scale: {type: str, default: "true"}
      scale_covs: {type: str, default: "true"}
    command: |
      python training.py --series-csv {series_csv} --series-uri {series_uri} --future-covs-csv {future_covs_csv} --future-covs-uri {future_covs_uri} --past-covs-csv {past_covs_csv}  --past-covs-uri {past_covs_uri} --cut-date-val {cut_date_val} --cut-date-test {cut_date_test} --test-end-date {test_end_date} --darts-model {darts_model} --device {device} --hyperparams-entrypoint {hyperparams_entrypoint} --scale {scale} --scale-covs {scale_covs}

  eval:
    parameters:
      mode: {type: str, default: remote}
      series_uri: {type: str, default: mlflow_artifact_uri}
      future_covs_uri: {type: str, default: mlflow_artifact_uri}
      past_covs_uri: {type: str, default: mlflow_artifact_uri}
      scaler_uri: {type: str, default: mlflow_artifact_uri}
      cut_date_test: {type: str, default: 20210101}
      test_end_date: {type: str, default: None}
      model_uri: {type: str, default: mlflow_artifact_uri}
      model_type: {type: str, default: pl}
      forecast_horizon: {type: str, default: 96}
      stride: {type: str, default: None}
      retrain: {type: str, default: "false"}
    command: |
      python evaluate_forecasts.py --mode {mode} --series-uri {series_uri} --future-covs-uri {future_covs_uri} --model-type {model_type} --past-covs-uri {past_covs_uri} --scaler-uri {scaler_uri} --cut-date-test {cut_date_test} --test-end-date {test_end_date} --model-uri {model_uri} --forecast-horizon {forecast_horizon} --stride {stride} --retrain {retrain}

  exp_pipeline:
    parameters:
      series_csv: {type: str, default: ../../RDN/Load_Data/2009-2021-global-load.csv}
      series_uri: {type: str, default: online_artifact}
      resolution: {type: str, default: 15}
      year_range: {type: str, default: 2009-2019}
      time_covs: {type: str, default: PT}
      hyperparams_entrypoint: {type: str, default: LSTM1}
      cut_date_val: {type: str, default: 20180101}
      cut_date_test: {type: str, default: 20190101}
      test_end_date: {type: str, default: None}
      darts_model: {type: str, default: RNN}
      device: {type: str, default: gpu}
      forecast_horizon: {type: str, default: 96}
      stride: {type: str, default: None}
      retrain: {type: str, default: false}
      ignore_previous_runs: {type: str, default: "true"}
      scale: {type: str, default: "true"}
      scale_covs: {type: str, default: "true"}
      day_first: {type: str, default: "true"}
    command: |
      python experimentation_pipeline.py --series-csv {series_csv} --series-uri {series_uri} --resolution {resolution} --year-range {year_range} --time-covs {time_covs} --cut-date-val {cut_date_val} --cut-date-test {cut_date_test} --test-end-date {test_end_date} --darts-model {darts_model} --device {device} --hyperparams-entrypoint {hyperparams_entrypoint} --forecast-horizon {forecast_horizon} --stride {stride} --retrain {retrain} --ignore-previous-runs {ignore_previous_runs} --scale {scale} --scale-covs {scale_covs} --day-first {day_first}

  inference:
    parameters:
      pyfunc_model_folder: {type: str, default: s3://mlflow-bucket/2/33d85746285c42a7b3ef403eb2f5c95f/artifacts/pyfunc_model}
      forecast_horizon:  {type: str, default: 960}
      series_uri: {type: str, default: ENG/series.csv}
      past_covariates_uri: {type: str, default: "None"}
      future_covariates_uri: {type: str, default: "None"}
      roll_size: {type: str, default: 96}
      batch_size:  {type: str, default: 1}

    command: |
      python inference.py --pyfunc-model-folder {pyfunc_model_folder} --forecast-horizon {forecast_horizon} --series-uri {series_uri} --past-covariates-uri {past_covariates_uri} --future-covariates-uri {future_covariates_uri} --roll-size {roll_size} --batch-size {batch_size}
